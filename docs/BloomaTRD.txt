# Blooma Technical Requirements Document (TRD)

## 1. Executive Summary
Blooma is a Next.js-based AI image generation platform focused on fashion lookbook workflows.
It integrates Google Gemini for image generation, Supabase (Postgres) for data, and R2 for asset storage.

## 2. Tech Stack
- **Framework**: Next.js 16 App Router, React 19, TypeScript
- **Styling**: Tailwind CSS, shadcn/ui
- **Database**: Supabase (Postgres)
- **Storage**: Cloudflare R2 (S3-compatible)
- **AI**: Google Gemini (image generation)
- **Auth**: Supabase Auth
- **Billing**: Polar

## 3. System Architecture
```
Client (Studio UI)
   -> /api/generate-image
      -> Google Gemini (Gemini 2.5 Flash Image / Gemini 3 Pro Image Preview)
      -> R2 (generated image cache)
   -> /api/studio/generated (save metadata)
   -> Supabase (generated_images)

Assets
   -> /api/upload-image
      -> R2 (models storage)
   -> /api/models
      -> Supabase (uploaded_models)
```

## 4. Data Model (Supabase)

### users
- `credits`, `credits_used`: 크레딧 관리
- `subscription_tier`: Small Brands / Agency / Studio
- `subscription_status`: active / canceled / revoked

### generated_images
- `image_url`: R2 저장 URL
- `prompt`: 생성 프롬프트
- `model_id`: 사용된 AI 모델 ID
- `source_model_url`: 소스 모델 이미지 URL
- `source_outfit_urls`: 소스 의류 이미지 URLs (JSON)

### uploaded_models
- `user_id`, `name`, `image_url`
- `is_public`: 시스템 공개 모델 여부

## 5. API Routes

### Image Generation
| Route | Method | Description |
|-------|--------|-------------|
| `/api/generate-image` | POST | Generate image via Gemini, cache to R2 |
| `/api/studio/generated` | GET/POST/DELETE | Gallery CRUD |
| `/api/studio/generated/[id]` | GET | Get single image detail |

### Assets
| Route | Method | Description |
|-------|--------|-------------|
| `/api/models` | GET/DELETE | Model library |
| `/api/upload-image` | POST | Upload to R2 |

### Billing
| Route | Method | Description |
|-------|--------|-------------|
| `/api/billing/checkout` | POST | Create checkout session |
| `/api/billing/status` | GET | Check subscription status |
| `/api/billing/webhook` | POST | Polar webhook handler |
| `/api/user/credits` | GET | Get credit balance |

## 6. Image Generation Flow

### Standard Mode (Gemini 2.5 Flash Image)
1. Client collects: model image + outfit refs + view type + prompt
2. `POST /api/generate-image` with `modelId: 'gemini-2.5-flash-image'`
3. Server builds prompt with view-specific pose
4. Gemini generates images
5. Images cached to R2
6. Client saves to Supabase via `/api/studio/generated`

### Pro Mode (Gemini 3 Pro Image Preview)
- Same flow with `modelId: 'gemini-3-pro-image-preview'`
- Supports 2K/4K resolution selection
- Higher credit cost (50 vs 15)

## 7. Prompt System
JSON-based structured prompt:
```json
{
  "image_type": "commercial_fashion_photography",
  "subject": {
    "model_source": "Use the face and body from reference",
    "pose": "standing_straight, front_view, arms_relaxed"
  },
  "apparel": {
    "instruction": "Wear the exact outfit from reference"
  },
  "environment": {
    "background": "seamless_pure_white_background"
  },
  "technical_specs": {
    "image_quality": "8k, photorealistic"
  }
}
```

## 8. Credit System
| Tier | Model | Credits/Image |
|------|-------|-------------:|
| Standard | Gemini 2.5 Flash Image | 15 |
| Pro | Gemini 3 Pro Image Preview | 50 |
| Pro 4K | Gemini 3 Pro Image Preview (4K) | 100 |

## 9. Storage Conventions
- Generated images: `projects/studio/storyboard/generated-{uuid}-{index}.png`
- Model assets: `models/{projectId}/{assetId}.{ext}`

## 10. Notes
- Video generation pipeline has been removed
- All images use R2 CDN for fast loading
- Public models are seeded via `/api/seed-models` (development only)
